<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game Caro Online</title>
    <script src="/webjars/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="/webjars/stomp-websocket/2.3.4/stomp.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(to bottom, #ffffff, #e0f7ff);
            margin: 0;
            padding: 20px;
            text-align: center;
        }
        h2 { color: #007bff; }
        #playerInfo { font-size: 16px; margin-bottom: 10px; }
        #scoreBoard {
            margin-bottom: 12px;
            font-size: 16px;
            color: #333;
        }
        #board {
            border-collapse: collapse;
            margin: 20px auto;
            box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
        }
        td {
            width: 35px; height: 35px; border: 1px solid #aaa;
            font-size: 20px; cursor: pointer; text-align: center; vertical-align: middle; transition: background 0.3s;
        }
        td:hover { background-color: #e6f2ff; }
        td.X { color: red; font-weight: bold; }
        td.O { color: green; font-weight: bold; }
        .footer { margin-top: 30px; font-size: 14px; color: #555; }
        #leaveBtn {
            padding: 8px 16px; background-color: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;
        }
        #leaveBtn:hover { background-color: #c82333; }
    </style>
</head>
<body>

<h2>üéØ Game Caro Online</h2>
<p id="playerInfo">Ch√†o <span id="playerName"></span>! B·∫°n l√†: <strong id="playerSymbol">(ƒëang ch·ªù...)</strong></p>
<div id="scoreBoard">
    <strong>T·ªâ s·ªë:</strong>
    <span id="scoreA">--</span>
</div>
<button id="leaveBtn">R·ªùi kh·ªèi tr·∫≠n ƒë·∫•u</button>
<table id="board"></table>
<div class="footer">
    ¬© 2025 Game Caro Online - Powered by Spring Boot & WebSocket
</div>

<script>
    const boardSize = 20;
    const board = document.getElementById("board");
    const playerName = prompt("Nh·∫≠p t√™n c·ªßa b·∫°n:").trim();
    document.getElementById("playerName").textContent = playerName;

    let playerSymbol = null;
    let currentTurn = "X";
    let stompClient = null;
    let boardData = Array.from({ length: boardSize }, () => Array(boardSize).fill(""));
    let players = {};
    let scores = {};

    // Hai bi·∫øn l∆∞u c·ªë ƒë·ªãnh t√™n 2 ng∆∞·ªùi ch∆°i xu·∫•t hi·ªán ƒë·∫ßu ti√™n
    let playerName1 = null;
    let playerName2 = null;

    // T·∫°o b·∫£ng
    for (let i = 0; i < boardSize; i++) {
        const row = board.insertRow();
        for (let j = 0; j < boardSize; j++) {
            const cell = row.insertCell();
            cell.dataset.x = i;
            cell.dataset.y = j;
        }
    }

    // C·∫≠p nh·∫≠t b·∫£ng
    function updateBoard(data) {
        for (let i = 0; i < boardSize; i++) {
            for (let j = 0; j < boardSize; j++) {
                const cell = board.rows[i].cells[j];
                const value = data[i][j];
                cell.textContent = value;
                cell.className = value;
            }
        }
    }

    // G√°n bi·ªÉu t∆∞·ª£ng cho ng∆∞·ªùi ch∆°i
    function assignSymbol(name, playerMap) {
        for (const symbol in playerMap) {
            if (playerMap[symbol] === name) {
                return symbol;
            }
        }
        return null;
    }

    // C·∫≠p nh·∫≠t score
    function updateScores(scores) {
        if (playerName1 && playerName2) {
            document.getElementById("scoreA").textContent =
                `${playerName1}: ${scores[playerName1] ?? 0} | ${playerName2}: ${scores[playerName2] ?? 0}`;
        } else if (playerName1) {
            document.getElementById("scoreA").textContent =
                `${playerName1}: ${scores[playerName1] ?? 0}`;
        } else {
            document.getElementById("scoreA").textContent = "--";
        }
    }

    // K·∫øt n·ªëi WebSocket
    window.onload = function () {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function () {
            console.log("üîó WebSocket ƒë√£ k·∫øt n·ªëi");

            stompClient.subscribe('/topic/board', function (message) {
                const data = JSON.parse(message.body);
                boardData = data.board;
                currentTurn = data.turn;
                players = data.players;
                scores = data.scores;

                // Khi ƒë·ªß 2 ng∆∞·ªùi ch∆°i v√† ch∆∞a set t√™n c·ªë ƒë·ªãnh th√¨ l·∫•y lu√¥n t√™n, sau n√†y kh√¥ng thay ƒë·ªïi n·ªØa
                const names = Object.values(players);
                if (names.length === 2 && (!playerName1 || !playerName2)) {
                    [playerName1, playerName2] = names;
                }

                // N·∫øu c√≥ ng∆∞·ªùi r·ªùi ph√≤ng, reset hai bi·∫øn t√™n (v√† b·∫£ng t·ªâ s·ªë s·∫Ω hi·ªÉn th·ªã l·∫°i "--")
                if (names.length < 2) {
                    playerName1 = names[0] || null;
                    playerName2 = null;
                }

                if (!playerSymbol || !players[playerSymbol] || players[playerSymbol] !== playerName) {
                    playerSymbol = assignSymbol(playerName, players);
                    document.getElementById("playerSymbol").textContent = playerSymbol || "(ch·ªù ph√¢n c√¥ng...)";
                }

                updateBoard(boardData);
                updateScores(scores);

            });

            // G·ª≠i th√¥ng tin ƒëƒÉng k√Ω ng∆∞·ªùi ch∆°i
            stompClient.send("/app/register", {}, JSON.stringify({ name: playerName }));
        });
    };

    // G·ª≠i n∆∞·ªõc ƒëi
    board.addEventListener("click", function (e) {
        const cell = e.target;
        if (cell.tagName !== "TD") return;

        const x = parseInt(cell.dataset.x);
        const y = parseInt(cell.dataset.y);

        if (boardData[x][y] !== "" || currentTurn !== playerSymbol) return;

        stompClient.send("/app/move", {}, JSON.stringify({
            x: x,
            y: y,
            player: playerSymbol
        }));
    });

    // R·ªùi kh·ªèi tr·∫≠n ƒë·∫•u
    document.getElementById("leaveBtn").addEventListener("click", function () {
        if (stompClient && playerName) {
            stompClient.send("/app/leave", {}, JSON.stringify({ name: playerName }));
            alert("üö™ B·∫°n ƒë√£ r·ªùi kh·ªèi tr·∫≠n ƒë·∫•u.");
            window.location.reload();
        }
    });

    // G·ª≠i t√≠n hi·ªáu r·ªùi n·∫øu ƒë√≥ng tab
    window.addEventListener("beforeunload", function () {
        if (stompClient && playerName) {
            stompClient.send("/app/leave", {}, JSON.stringify({ name: playerName }));
        }
    });
</script>

</body>
</html>